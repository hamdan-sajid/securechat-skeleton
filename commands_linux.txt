# Linux/Mac Commands for SecureChat

# 1. Create virtual environment
python3 -m venv .venv

# 2. Activate virtual environment
source .venv/bin/activate

# 3. Install dependencies
pip install -r requirements.txt

# 4. Create .env file (same content as Windows)
DB_HOST=localhost
DB_PORT=3307
DB_USER=scuser
DB_PASSWORD=scpass
DB_NAME=securechat

CA_CERT_PATH=certs/ca_cert.pem
SERVER_CERT_PATH=certs/server_cert.pem
SERVER_KEY_PATH=certs/server_key.pem
CLIENT_CERT_PATH=certs/client_cert.pem
CLIENT_KEY_PATH=certs/client_key.pem

SERVER_CN=server.local
CLIENT_CN=client.local

SERVER_HOST=localhost
SERVER_PORT=8888

# 5. Start MySQL container (if not already running)
docker run -d --name securechat-db \
  -e MYSQL_ROOT_PASSWORD=rootpass \
  -e MYSQL_DATABASE=securechat \
  -e MYSQL_USER=scuser \
  -e MYSQL_PASSWORD=scpass \
  -p 3307:3306 \
  mysql:8

# 6. Verify container is running
docker ps

# 7. If container already exists, start it:
docker start securechat-db

# 8. Create database tables
python3 -m app.storage.db --init

# 9. Generate Root CA
python3 scripts/gen_ca.py --name "FAST-NU Root CA" --out certs

# 10. Generate server certificate
python3 scripts/gen_cert.py --cn server.local --out server --dir certs

# 11. Generate client certificate
python3 scripts/gen_cert.py --cn client.local --out client --dir certs

# 12. Run server
python3 -m app.server

# 13. Run client (in another terminal)
python3 -m app.client

# 14. Verify transcript and receipt
python3 scripts/verify_receipt.py \
  --transcript transcripts/transcript_<session_id>.txt \
  --receipt transcripts/receipt_<session_id>_server.json \
  --cert certs/server_cert.pem \
  --message-cert certs/client_cert.pem
  
python3 scripts/verify_receipt.py \
  --transcript transcripts/transcript_127.0.0.1_53698_1763197474957.txt \
  --receipt transcripts/receipt_127.0.0.1_53698_1763197474957_server.json \
  --cert certs/server_cert.pem \
  --message-cert certs/client_cert.pem

# 15. View database
docker exec -it securechat-db mysql -uscuser -pscpass securechat
# Then run:
SHOW TABLES;
DESCRIBE users;
SELECT email, username, HEX(salt) as salt, pwd_hash FROM users;
# EXIT;


# Generate an expired client certificate (expired 1 day ago)
python3 scripts/gen_expired_cert.py --cn expired.client.local --out expired_client --days-expired 1

# Or expired 30 days ago
python3 scripts/gen_expired_cert.py --cn expired.client.local --out expired_client --days-expired 30

# Using OpenSSL (selfsigned cert)
   openssl req -x509 -newkey rsa:2048 -keyout certs/fake_client_key.pem -out certs/fake_client_cert.pem -days 365 -nodes -subj "/CN=fake.client"
   
   # Generate a forged client certificate
python3 scripts/gen_forged_cert.py --cn forged.client.local --out forged_client
   
python3 scripts/test_tamper_live.py hamdansajid@gmail.com 123

python3 scripts/test_replay_live.py hamdansajid@gmail.com 123
